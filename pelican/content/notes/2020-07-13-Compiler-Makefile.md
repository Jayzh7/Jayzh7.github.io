---
title: Compiling - Makefile
date: 2020-07-13 12:05 +0800 
summary: Makefile is necessary for building large, complicated projects.
category: Notes
visible: True
tags: compiler, backend
---

Definition from [Wikipedia](https://en.wikipedia.org/wiki/Makefile#:~:text=A%20makefile%20is%20a%20file,to%20generate%20a%20target%2Fgoal.):
> A makefile is a file containing a set of directives used by a make build automation tool to generate a target/goal.

## Rules

Rules are in the following form:

```makefile
target: dependencies
    system command(s)
```

__target__: name of file generated by a program, such as object files. It can also be the name of an action, such as "clean".
__dependencies__: input for creating the target.

__system command(s)__ (__recipe__): action for `make`, should be indented at least for 1 tab.

## An example
The following example compiles all `.c` and `.cpp` files to object files and link them to an executable called `helloworld`.

```makefile
# variables
CC = gcc
XX = g++
CFLAGS = -Wall -O -g
TARGET = helloworld

# Compile all .c files to object files
%.o:%.c
	$(CC) $(CFLAGS) -c $< -o $@

# Compile all .cpp files to object files
%.o:%.cpp
	$(XX) $(CFLAGS) -c $< -o $@

# Use wildcard to match all .c and .cpp files
SOURCES = $(wildcard *.c *.cpp)
# replace the suffix of .c and .cpp in SOURCE with .o
OBJS = $(patsubst %.c,%.o,$(patsubst %.cpp,%.o,$(SOURCES)))

# link all object files to an executable.
$(TARGET):$(OBJS)
	$(XX) $(OBJS) -o $(TARGET)
clean:
	rm -rf *.o helloworld

```

## Macros

### Pre-defined macros
`$@`: target  
`$<`: first dependency  
`$^`: all dependencies  
`% `: a pattern we want to watch in both the target and the dependency. (?)
### New macros  
```makefile
# macros are capitalized
MACRO = definition
# reference of macro
NEW_MACRO = $(MACRO)
# Macros can contain shell commands by using backticks `.
YYYYMMDD = `  date`
```

macros can be defined when calling `make`
```makefile
make MACRO="macro" 
```

## Suffix rules
## Pattern rules

PACKAGE	 = package
# save date in a specified format
VERSION	 = ` date "+%Y.%m%d%" `
RELEASE_DIR  = ..
# concatenate two variable
RELEASE_FILE = $(PACKAGE)-$(VERSION)

```makefile
# Notice that the variable LOGNAME comes from the environment in
# POSIX shells.
#
# target: all - Default target. Does nothing.
all:
	echo "Hello $(LOGNAME), nothing to do by default"
    # sometimes: echo "Hello ${LOGNAME}, nothing to do by default"
	echo "Try 'make help'"

# target: help - Display callable targets.
help:
    # grep all lines start with "# target" to print help
	egrep "^# target:" [Mm]akefile

# target: dist - Make a release.
dist:
	tar -cf  $(RELEASE_DIR)/$(RELEASE_FILE) && \
	gzip -9  $(RELEASE_DIR)/$(RELEASE_FILE).tar
```

# References
[_Makefile - Wikipedia_](https://en.wikipedia.org/wiki/Makefile#:~:text=A%20makefile%20is%20a%20file,to%20generate%20a%20target%2Fgoal.)  
[_后台开发：核心技术与应用实践_](https://m.douban.com/book/subject/26850616/)  
[_Make(Software) - Wikipedia_](https://en.wikipedia.org/wiki/Make_(software))