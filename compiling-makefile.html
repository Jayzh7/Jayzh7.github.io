<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Compiling - Makefile</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Techspace </a></h1>
                <nav><ul>
    
                        <li><a href="/pages/about-me.html">about me</a></li>
                    <li><a href="/category/leetcode.html">LeetCode</a></li>
                    <li class="active"><a href="/category/notes.html">Notes</a></li>
                    <li><a href="/category/other.html">Other</a></li>
                </ul>
                </nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/compiling-makefile.html" rel="bookmark"
           title="Permalink to Compiling - Makefile">Compiling - Makefile</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <span>Mon 13 July 2020</span>
<span>| tags: <a href="/tag/compiler.html">compiler</a><a href="/tag/backend.html">backend</a></span>
</footer><!-- /.post-info -->      <p>Definition from <a href="https://en.wikipedia.org/wiki/Makefile#:~:text=A%20makefile%20is%20a%20file,to%20generate%20a%20target%2Fgoal.">Wikipedia</a>:</p>
<blockquote>
<p>A makefile is a file containing a set of directives used by a make build automation tool to generate a target/goal.</p>
</blockquote>
<h2>Rules</h2>
<p>Rules are in the following form:</p>
<div class="highlight"><pre><span></span><span class="nf">target</span><span class="o">:</span> <span class="n">dependencies</span>
    system command<span class="o">(</span>s<span class="o">)</span>
</pre></div>


<p><strong>target</strong>: name of file generated by a program, such as object files. It can also be the name of an action, such as "clean".
<strong>dependencies</strong>: input for creating the target.</p>
<p><strong>system command(s)</strong> (<strong>recipe</strong>): action for <code>make</code>, should be indented at least for 1 tab.</p>
<h2>An example</h2>
<p>The following example compiles all <code>.c</code> and <code>.cpp</code> files to object files and link them to an executable called <code>helloworld</code>.</p>
<div class="highlight"><pre><span></span><span class="c"># variables</span>
<span class="nv">CC</span> <span class="o">=</span> gcc
<span class="nv">XX</span> <span class="o">=</span> g++
<span class="nv">CFLAGS</span> <span class="o">=</span> -Wall -O -g
<span class="nv">TARGET</span> <span class="o">=</span> helloworld

<span class="c"># Compile all .c files to object files</span>
<span class="nf">%.o</span><span class="o">:</span>%.<span class="n">c</span>
    <span class="k">$(</span>CC<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c $&lt; -o <span class="nv">$@</span>

<span class="c"># Compile all .cpp files to object files</span>
<span class="nf">%.o</span><span class="o">:</span>%.<span class="n">cpp</span>
    <span class="k">$(</span>XX<span class="k">)</span> <span class="k">$(</span>CFLAGS<span class="k">)</span> -c $&lt; -o <span class="nv">$@</span>

<span class="c"># Use wildcard to match all .c and .cpp files</span>
<span class="nv">SOURCES</span> <span class="o">=</span> <span class="k">$(</span>wildcard *.c *.cpp<span class="k">)</span>
<span class="c"># replace the suffix of .c and .cpp in SOURCE with .o</span>
<span class="nv">OBJS</span> <span class="o">=</span> <span class="k">$(</span>patsubst %.c,%.o,<span class="k">$(</span>patsubst %.cpp,%.o,<span class="k">$(</span>SOURCES<span class="k">)))</span>

<span class="c"># link all object files to an executable.</span>
<span class="nf">$(TARGET)</span><span class="o">:</span><span class="k">$(</span><span class="nv">OBJS</span><span class="k">)</span>
    <span class="k">$(</span>XX<span class="k">)</span> <span class="k">$(</span>OBJS<span class="k">)</span> -o <span class="k">$(</span>TARGET<span class="k">)</span>
<span class="nf">clean</span><span class="o">:</span>
    rm -rf *.o helloworld
</pre></div>


<h2>Macros</h2>
<h3>Pre-defined macros</h3>
<p><code>$@</code>: target<br>
<code>$&lt;</code>: first dependency<br>
<code>$^</code>: all dependencies<br>
<code>%</code>: a pattern we want to watch in both the target and the dependency. (?)</p>
<h3>New macros</h3>
<div class="highlight"><pre><span></span><span class="c"># macros are capitalized</span>
<span class="nv">MACRO</span> <span class="o">=</span> definition
<span class="c"># reference of macro</span>
<span class="nv">NEW_MACRO</span> <span class="o">=</span> <span class="k">$(</span>MACRO<span class="k">)</span>
<span class="c"># Macros can contain shell commands by using backticks `.</span>
<span class="nv">YYYYMMDD</span> <span class="o">=</span> <span class="sb">`</span>  date<span class="sb">`</span>
</pre></div>


<p>macros can be defined when calling <code>make</code></p>
<div class="highlight"><pre><span></span><span class="err">make</span> <span class="nv">MACRO</span><span class="o">=</span><span class="s2">&quot;macro&quot;</span> 
</pre></div>


<h2>Suffix rules</h2>
<h2>Pattern rules</h2>
<p>PACKAGE  = package</p>
<h1>save date in a specified format</h1>
<p>VERSION  = <code>date "+%Y.%m%d%"</code>
RELEASE_DIR  = ..</p>
<h1>concatenate two variable</h1>
<p>RELEASE_FILE = $(PACKAGE)-$(VERSION)</p>
<div class="highlight"><pre><span></span><span class="c"># Notice that the variable LOGNAME comes from the environment in</span>
<span class="c"># POSIX shells.</span>
<span class="c">#</span>
<span class="c"># target: all - Default target. Does nothing.</span>
<span class="nf">all</span><span class="o">:</span>
    <span class="nb">echo</span> <span class="s2">&quot;Hello </span><span class="k">$(</span>LOGNAME<span class="k">)</span><span class="s2">, nothing to do by default&quot;</span>
<span class="c">    # sometimes: echo &quot;Hello ${LOGNAME}, nothing to do by default&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Try &#39;make help&#39;&quot;</span>

<span class="c"># target: help - Display callable targets.</span>
<span class="nf">help</span><span class="o">:</span>
<span class="c">    # grep all lines start with &quot;# target&quot; to print help</span>
    egrep <span class="s2">&quot;^# target:&quot;</span> <span class="o">[</span>Mm<span class="o">]</span>akefile

<span class="c"># target: dist - Make a release.</span>
<span class="nf">dist</span><span class="o">:</span>
    tar -cf  <span class="k">$(</span>RELEASE_DIR<span class="k">)</span>/<span class="k">$(</span>RELEASE_FILE<span class="k">)</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
    gzip -9  <span class="k">$(</span>RELEASE_DIR<span class="k">)</span>/<span class="k">$(</span>RELEASE_FILE<span class="k">)</span>.tar
</pre></div>


<h1>References</h1>
<p><a href="https://en.wikipedia.org/wiki/Makefile#:~:text=A%20makefile%20is%20a%20file,to%20generate%20a%20target%2Fgoal."><em>Makefile - Wikipedia</em></a><br>
<a href="https://m.douban.com/book/subject/26850616/"><em>后台开发：核心技术与应用实践</em></a><br>
<a href="https://en.wikipedia.org/wiki/Make_(software)"><em>Make(Software) - Wikipedia</em></a></p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">FB</a></li>
                            <li><a href="#">INS</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <p>Powered by <a href="http://getpelican.com/">Pelican</a>. Theme <a href="https://github.com/blueicefield/pelican-blueidea/">blueidea</a>, inspired by the default theme.</p>
        </footer><!-- /#contentinfo -->

</body>
</html>